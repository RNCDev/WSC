<script>
    let gridData = [];
    let headers = [];
    let generatedTeams = null;

    function loadCSV() {
        console.log('Attempting to load CSV...');
        Papa.parse('Membership.csv', {
            download: true,
            header: true,
            complete: function(results) {
                console.log('CSV loaded successfully:', results);
                gridData = results.data;
                headers = results.meta.fields;
                renderGrid();
            },
            error: function(error) {
                console.error('Error loading CSV:', error);
                document.getElementById('loadingMessage').textContent = 'Error loading CSV. Please check the console for details.';
            }
        });
    }

    function renderGrid() {
        console.log('Rendering grid...');
        const grid = document.getElementById('grid');
        grid.innerHTML = '';

        // Create header row
        const headerRow = document.createElement('tr');
        headers.forEach(key => {
            const th = document.createElement('th');
            th.textContent = key;
            headerRow.appendChild(th);
        });
        grid.appendChild(headerRow);

        // Create data rows
        gridData.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            headers.forEach(key => {
                const td = document.createElement('td');
                const input = document.createElement('input');
                input.value = row[key] || '';
                input.addEventListener('change', (e) => {
                    gridData[rowIndex][key] = e.target.value;
                    updateLastModifiedTime();
                });
                td.appendChild(input);
                tr.appendChild(td);
            });
            grid.appendChild(tr);
        });

        document.getElementById('loadingMessage').style.display = 'none';
        console.log('Grid rendered successfully');
    }

    function updateLastModifiedTime() {
        const now = new Date();
        document.getElementById('lastUpdateTime').textContent = `Last updated: ${now.toLocaleString()}`;
    }

    function generateBalancedTeams() {
        console.log('Generating balanced teams...');
        // ... (rest of the function remains the same)
    }

    function goToRosters() {
        console.log('Going to rosters...');
        // ... (rest of the function remains the same)
    }

    function saveGrid() {
        console.log('Saving grid...');
        // ... (rest of the function remains the same)
    }

    function addRow() {
        console.log('Adding new row...');
        const newRow = {};
        headers.forEach(key => {
            newRow[key] = '';
        });
        gridData.push(newRow);
        renderGrid();
        updateLastModifiedTime();
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded and parsed');
        document.getElementById('generateRosters').addEventListener('click', generateBalancedTeams);
        document.getElementById('goToRosters').addEventListener('click', goToRosters);
        document.getElementById('saveGrid').addEventListener('click', saveGrid);
        document.getElementById('addRow').addEventListener('click', addRow);
        loadCSV();
    });
</script>
