<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSC Roster Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th, td { padding: 6px 8px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th, #memberGrid tr:first-child th:last-child { background-color: #f2f2f2 !important; }
        button { margin: 10px 5px 10px 0; padding: 5px 10px; }
        input[type="text"] { width: 90%; padding: 4px; border: none; background-color: transparent; font-size: 14px; }
        .action-column { width: 80px; }
        #fileInput { display: none; }
        .instructions { background-color: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .section { display: none; }
        .visible { display: block; }
        .team { background-color: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .red-team { border-top: 5px solid #ff4136; }
        .white-team { border-top: 5px solid #7FDBFF; }
        .position-group { margin-bottom: 20px; }
        .position-group h3 { color: #666; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
        .position-group ul { list-style-type: none; padding: 0; }
        .position-group li { background-color: #f9f9f9; margin-bottom: 5px; padding: 8px 12px; border-radius: 4px; font-size: 14px; }
        .position-group li:hover { background-color: #e9e9e9; }
    </style>
</head>
<body>
    <h1>WSC Roster Builder</h1>
    <div>
        <button onclick="toggleSection('builderSection')">Toggle Builder</button>
        <button onclick="toggleSection('rosterSection')">Toggle Roster</button>
    </div>
    <div id="builderSection" class="section visible">
        <div class="instructions">
            <h2>Instructions:</h2>
            <ol>
                <li>Upload a CSV file with player data using the "Upload CSV" button.</li>
                <li>Edit player information directly in the grid [Name, Skill, Defense/Offense, Attendance].</li>
                <li>Add or remove rows as needed.</li>
                <li>Click "Generate Roster" to create balanced teams.</li>
            </ol>
        </div>
        <input type="file" id="fileInput" accept=".csv">
        <button id="uploadButton">Upload CSV</button>
        <button id="addRow">Add Row</button>
        <button id="generateRoster">Generate Roster</button>
        <button id="clearGrid">Clear</button>
        <table id="memberGrid"></table>
    </div>
    <div id="rosterSection" class="section">
        <div class="team red-team">
            <h2>Red Team</h2>
            <div class="position-group">
                <h3>Forwards</h3>
                <ul id="redForward"></ul>
            </div>
            <div class="position-group">
                <h3>Defensemen</h3>
                <ul id="redDefense"></ul>
            </div>
        </div>
        <div class="team white-team">
            <h2>White Team</h2>
            <div class="position-group">
                <h3>Forwards</h3>
                <ul id="whiteForward"></ul>
            </div>
            <div class="position-group">
                <h3>Defensemen</h3>
                <ul id="whiteDefense"></ul>
            </div>
        </div>
    </div>
    <script>
        let gridData = [], headers = [];
        
        function toggleSection(sectionId) {
            document.getElementById(sectionId).classList.toggle('visible');
        }

        function handleFileUpload(event) {
            Papa.parse(event.target.files[0], {
                header: true,
                complete: function(results) {
                    gridData = results.data;
                    headers = results.meta.fields;
                    saveGridData();
                    renderGrid();
                },
                error: error => console.error('Error parsing CSV:', error)
            });
        }

        function renderGrid() {
            const grid = document.getElementById('memberGrid');
            grid.innerHTML = '';
            const headerRow = grid.insertRow();

            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });

            const actionTh = document.createElement('th');
            actionTh.textContent = 'Action';
            actionTh.className = 'header-action';
            headerRow.appendChild(actionTh);

            gridData.forEach((row, index) => {
                const tr = grid.insertRow();

                headers.forEach(header => {
                    const td = tr.insertCell();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = row[header] || '';
                    input.addEventListener('change', e => {
                        gridData[index][header] = e.target.value;
                        saveGridData();
                    });
                    td.appendChild(input);
                });

                const actionCell = tr.insertCell();
                actionCell.className = 'action-column';
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => deleteRow(index);
                actionCell.appendChild(deleteButton);
            });
        }
        
        function addRow() {
            gridData.push(Object.fromEntries(headers.map(header => [header, ''])));
            saveGridData();
            renderGrid();
        }
        
        function deleteRow(index) {
            gridData.splice(index, 1);
            saveGridData();
            renderGrid();
        }

        function saveGridData() {
            localStorage.setItem('gridData', JSON.stringify(gridData));
            localStorage.setItem('headers', JSON.stringify(headers));
        }

        function loadGridData() {
            const savedGridData = localStorage.getItem('gridData');
            const savedHeaders = localStorage.getItem('headers');
            if (savedGridData && savedHeaders) {
                gridData = JSON.parse(savedGridData);
                headers = JSON.parse(savedHeaders);
                renderGrid();
            }
        }

        function clearGrid() {
            gridData = [];
            headers = [];
            localStorage.removeItem('gridData');
            localStorage.removeItem('headers');
            renderGrid();
        }
        
        function generateRosters(gridData) {
            const attendingPlayers = gridData.filter(player => player.Attendance === "1");
            if (attendingPlayers.length === 0) {
                console.warn("No attending players found. Cannot generate rosters.");
                return [];
            }
        
            attendingPlayers.forEach(player => {
                player.Skill = parseFloat(player.Skill);
                player.position = player.Defense === "1" ? "Defense" : "Forward";
            });
        
            const teams = { Red: [], White: [] };
            const teamScores = { Red: 0, White: 0 };
        
            const sortedPlayers = attendingPlayers.sort((a, b) => b.Skill - a.Skill);
        
            sortedPlayers.forEach((player, index) => {
                const team = index % 2 === 0 ? 'Red' : 'White';
                teams[team].push({
                    First: player.First,
                    Last: player.Last,
                    position: player.position,
                    team: team,
                    Skill: player.Skill
                });
                teamScores[team] += player.Skill;
            });
        
            return [...teams.Red, ...teams.White];
        }

        function generateRoster() {
            const rosters = generateRosters(gridData);
            if (rosters.length > 0) {
                displayRosters(rosters);
                toggleSection('rosterSection');
            } else {
                alert("No rosters generated. Please check the player data.");
            }
        }

        function displayRosters(teamData) {
            ['redForward', 'redDefense', 'whiteForward', 'whiteDefense'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        
            teamData.forEach(player => {
                const li = document.createElement('li');
                li.textContent = `${player.First} ${player.Last} (Skill: ${player.Skill})`;
                const listId = `${player.team.toLowerCase()}${player.position}`;
                document.getElementById(listId).appendChild(li);
            });
        }

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('uploadButton').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('addRow').onclick = addRow;
        document.getElementById('generateRoster').onclick = generateRoster;
        document.getElementById('clearGrid').onclick = clearGrid;

        window.onload = loadGridData;
    </script>
</body>
</html>
